<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>TBC BIS Loots - Multi-raids</title>
<style>
body {
  font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  background: #111827;
  color: #e5e7eb;
  padding: 2rem;
}
h1 {
  color: #fbbf24;
  margin-bottom: 0.5rem;
}
p.subtitle {
  color: #9ca3af;
  margin-bottom: 1.5rem;
}

  /* --- Credits + BuyMeACoffee block --- */
.credits-container {
  position: absolute;
  top: 20px;
  right: 20px;
  text-align: right;
}

.credits-container img {
  width: 180px; /* ajustable */
  border-radius: 6px;
  margin-bottom: 0.6rem;
}

/* Texte des cr√©dits */
.credits-list p {
  margin: 0;
  color: #d1d5db;
  font-size: 0.85rem;
}

.credits-list span {
  color: #fbbf24;
  font-weight: 600;
}
/* Barre de s√©lection */
.controls {
  display: flex;
  flex-wrap: wrap;
  gap: 0.75rem;
  margin-bottom: 1rem;
  align-items: center;
}
.controls label {
  font-size: 0.9rem;
  color: #d1d5db;
}
.controls select {
  background: #111827;
  color: #e5e7eb;
  border: 1px solid #374151;
  border-radius: 0.375rem;
  padding: 0.3rem 0.6rem;
  font-size: 0.9rem;
}

/* Table pleine largeur */
table {
  border-collapse: collapse;
  width: 100vw;
  max-width: 100vw;
  margin-left: calc(-50vw + 50%);
  font-size: 0.9rem;
}
th, td {
  border: 1px solid #374151;
  padding: 0.4rem 1rem 0.4rem 1.2rem; /* top, right, bottom, left */
  font-size: 1.05rem;    
  vertical-align: middle;      
}
th {
  background: #1f2937;
  font-weight: 600;
  text-align: left;
}
tr:nth-child(even) td {
  background: #030712;
}
a:not([href*="wowhead.com"]) {
  color: #60a5fa;
}
  a {
  text-decoration: none;
}
a:hover {
  text-decoration: underline;
}

.boss-title td {
  background: #1f2937;
  color: #fbbf24;
  font-weight: 700;
  font-size: 2rem!important;
  text-align: left;   
  border-top: 2px solid #4b5563;
  border-bottom: 2px solid #4b5563;
  padding: 1rem 1rem 1rem 1.4rem;
}

.loot-col { width: 22%; }
.type-col { width: 12%; }
.notes-col { width: 28%; }
  
#lootBody td:first-child a.icontinyl {
  background-size: 20px 20px !important;  /* taille de l'ic√¥ne */
  padding-left: 30px !important;          /* espace pour laisser la place √† l'ic√¥ne */
  min-height: 20px;                       /* pour aligner verticalement */
  display: inline-flex;
  align-items: center;
}


/* Couleurs des classes WoW */
.wow-druid   { color: #FF7D0A; }
.wow-hunter  { color: #ABD473; }
.wow-mage    { color: #40C7EB; }
.wow-paladin { color: #F58CBA; }
.wow-priest  { color: #FFFFFF; }
.wow-rogue   { color: #FFF569; }
.wow-shaman  { color: #0070DE; }
.wow-warlock { color: #8787ED; }
.wow-warrior { color: #C79C6E; }

/* Raret√© BIS */
.rarity-bp {
  font-weight: 700;
}
.rarity-common    { color: #ffffff; } /* BP1 : blanc  */
.rarity-uncommon  { color: #1eff00; } /* BP2 : vert   */
.rarity-rare      { color: #0070dd; } /* BP3 : bleu   */
.rarity-epic      { color: #a335ee; } /* BP4 : violet */
.rarity-legendary { color: #ff8000; } /* BP5 : orange */
</style>

<script>
  // Wowhead tooltips
  var whTooltips = {
    colorLinks: true,
    iconizeLinks: true,
    renameLinks: false,
    locale: "fr_FR"
  };
</script>
<script src="https://wow.zamimg.com/widgets/power.js"></script>
</head>
<body>
  
  <div class="credits-container">
  <div class="bmc-button">
    <a href="https://www.buymeacoffee.com/Tozz" target="_blank">
      <img src="https://img.buymeacoffee.com/button-api/?text=Buy me a coffee&emoji=&slug=Tozz&button_colour=FFDD00&font_colour=000000&font_family=Cookie&outline_colour=000000&coffee_colour=ffffff" />
    </a>
  </div>

  <div class="credits-list">
    <p><span>Datamining :</span> Kerishai</p>
    <p><span>Ideas & Seeking :</span> Captp</p>
    <p><span>Conception :</span> Tozz</p>
  </div>
</div>

<h1>TBC ‚Äì BIS Loots by MEUPORG</h1>
<p class="subtitle">
Choisissez un raid et un boss pour afficher les loots. Survolez le nom pour voir le tooltip Wowhead.
</p>

<div class="controls">
  <label for="raidSelect">Raid :</label>
  <select id="raidSelect"></select>

  <label for="bossSelect">Boss :</label>
  <select id="bossSelect">
    <option value="">Tous les boss</option>
  </select>
</div>

<table>
  <thead>
    <tr>
      <th class="loot-col">Loot</th>
      <th class="type-col">Type</th>
      <th>BIS</th>
      <th>Sp√© 1</th>
      <th>Sp√© 2</th>
      <th>Priorit√©</th>
      <th class="notes-col">Notes</th>
    </tr>
  </thead>
  <tbody id="lootBody">
    <!-- Rempli dynamiquement -->
  </tbody>
</table>

<script>
// === Config des raids (chemins CSV) ===============================
const RAIDS = [
   { id: "karazhan",  name: "[P1] Karazhan", csv: "CSV/karazhan.csv" },
  { id: "mags_gruul_worldboss", name: "[P1] Magtheridon / Gruul / World Boss", csv: "CSV/mags_gruul_worldboss.csv" },
  { id: "ssc",       name: "[P2] Caverne du sanctuaire du Serpent", csv: "CSV/ssc.csv" },
  { id: "tk",        name: "[P2] Donjon de la Temp√™te (The Eye)", csv: "CSV/tk.csv" },
  { id: "hyjal",     name: "[P3] Sommet d‚ÄôHyjal", csv: "CSV/hyjal.csv" },
  { id: "bt",        name: "[P3] Temple noir (BT)", csv: "CSV/bt.csv" },
  { id: "za",        name: "[P4] Zul‚ÄôAman", csv: "CSV/za.csv" },
  { id: "swp",       name: "[P5] Plateau du Puits de soleil (SWP)", csv: "CSV/swp.csv" },
  { id: "t4",        name: "[P1] Set T4", csv: "CSV/t4.csv" },
  { id: "t5",        name: "[P2] Set T5", csv: "CSV/t5.csv" },
  { id: "t6",        name: "[P3] Set T6", csv: "CSV/t6.csv" }
];

// === Mapping classes -> couleurs ===============================
const wowClassMap = {
  "Holy Paladin": "wow-paladin",
  "Resto Shaman": "wow-shaman",
  "Resto Druid": "wow-druid",
  "Prot Paladin": "wow-paladin",
  "Prot Warrior": "wow-warrior",
  "War Fury": "wow-warrior",
  "War Armes": "wow-warrior",
  "War Tank": "wow-warrior",

  "Druide": "wow-druid",
  "Druid": "wow-druid",
  "RDru": "wow-druid",
  "Feral": "wow-druid",
  "Bear": "wow-druid",
  "Cat": "wow-druid",
  "Boom": "wow-druid",
  "Boomy": "wow-druid",

  "Hunt": "wow-hunter",
  "Chasseur": "wow-hunter",
  "Hunter": "wow-hunter",
  "Chassou": "wow-hunter",

  "Mage": "wow-mage",

  "Paladin": "wow-paladin",
  "HPal": "wow-paladin",
  "PPal": "wow-paladin",
  "Ret": "wow-paladin",

  "Priest": "wow-priest",
  "HPri": "wow-priest",
  "Shadow": "wow-priest",

  "Rog": "wow-rogue",
  "Rogue": "wow-rogue",

  "Shaman": "wow-shaman",
  "RSha": "wow-shaman",
  "Ele": "wow-shaman",
  "Enh": "wow-shaman",
  "Am√©lio": "wow-shaman",

  "Lock": "wow-warlock",
  "Warlock": "wow-warlock",

  "Warrior": "wow-warrior",
  "PWar": "wow-warrior",
  "Fury": "wow-warrior",
  "Arms": "wow-warrior"
};

// Pr√©-tri des cl√©s par longueur (pour √©viter "Paladin" avant "Holy Paladin")
const CLASS_KEYS = Object.keys(wowClassMap).sort((a, b) => b.length - a.length);

// === CSV parser maison (g√®re les quotes, virgules, retours) =====
function parseCSV(text) {
  const rows = [];
  let field = "";
  let row = [];
  let inQuotes = false;

  for (let i = 0; i < text.length; i++) {
    const c = text[i];

    if (c === '"') {
      if (inQuotes && text[i + 1] === '"') {
        // quote √©chapp√© ""
        field += '"';
        i++;
      } else {
        inQuotes = !inQuotes;
      }
    } else if (c === ',' && !inQuotes) {
      row.push(field);
      field = "";
    } else if ((c === '\n' || c === '\r') && !inQuotes) {
      if (field.length > 0 || row.length > 0) {
        row.push(field);
        rows.push(row);
      }
      field = "";
      row = [];
      // g√©rer \r\n
      if (c === '\r' && text[i + 1] === '\n') {
        i++;
      }
    } else {
      field += c;
    }
  }

  // Derni√®re ligne
  if (field.length > 0 || row.length > 0) {
    row.push(field);
    rows.push(row);
  }

  return rows;
}

// Transforme en objets avec les noms de colonnes
function csvToObjects(text) {
  const rows = parseCSV(text);
  if (!rows.length) return [];
  const headers = rows[0].map(h => h.trim());
  const data = [];

  for (let i = 1; i < rows.length; i++) {
    const row = rows[i];
    if (row.every(v => !v || v.trim() === "")) continue;
    const obj = {};
    headers.forEach((h, idx) => {
      obj[h] = row[idx] !== undefined ? row[idx] : "";
    });
    data.push(obj);
  }
  return data;
}

// === Helpers pour la mise en forme texte =======================
function escapeHTML(str) {
  return str
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;");
}

function formatCellText(value) {
  if (!value) return "";
  return escapeHTML(value).replace(/\n/g, "<br>");
}

// === Donn√©es courantes =========================================
let currentRaidId = null;
let currentData = [];

// === Chargement d'un raid ======================================
async function loadRaid(raidId) {
  const raid = RAIDS.find(r => r.id === raidId);
  if (!raid) return;

  currentRaidId = raidId;
  const res = await fetch(raid.csv);
  const text = await res.text();
  currentData = csvToObjects(text);

  populateBossSelect();
  renderTable();
}

// Remplir le select des boss
function populateBossSelect() {
  const bossSelect = document.getElementById("bossSelect");
  bossSelect.innerHTML = "";

  const optAll = document.createElement("option");
  optAll.value = "";
  optAll.textContent = "Tous les boss";
  bossSelect.appendChild(optAll);

  const bosses = [];
  currentData.forEach(row => {
    const b = (row.boss || "").trim();
    if (b && !bosses.includes(b)) bosses.push(b);
  });

  bosses.forEach(bossName => {
    const opt = document.createElement("option");
    opt.value = bossName;
    opt.textContent = bossName;
    bossSelect.appendChild(opt);
  });
}

// Rendu du tableau
function renderTable() {
  const tbody = document.getElementById("lootBody");
  tbody.innerHTML = "";

  const bossFilter = document.getElementById("bossSelect").value;

  const filtered = currentData.filter(row => {
    if (!bossFilter) return true;
    return (row.boss || "").trim() === bossFilter;
  });

  let lastBoss = null;

  filtered.forEach(row => {
    const bossName = (row.boss || "").trim();

    if (bossName && bossName !== lastBoss) {
      const trBoss = document.createElement("tr");
      trBoss.className = "boss-title";
      const td = document.createElement("td");
      td.colSpan = 7;
      td.textContent = bossName;
      trBoss.appendChild(td);
      tbody.appendChild(trBoss);
      lastBoss = bossName;
    }

    const tr = document.createElement("tr");

    const tdLoot = document.createElement("td");
    const lootName = row.loot_name || "";
    const lootUrl = row.loot_url || "";
    if (lootUrl) {
      tdLoot.innerHTML =
        '<a href="' + escapeHTML(lootUrl) + '">' + escapeHTML(lootName) + '</a>';
    } else {
      tdLoot.textContent = lootName;
    }

    const tdType = document.createElement("td");
    tdType.innerHTML = formatCellText(row.type || "");

    const tdBis = document.createElement("td");
    const bisText = (row.bis || "").trim();
    tdBis.textContent = bisText;

    const tdSpec1 = document.createElement("td");
    tdSpec1.innerHTML = formatCellText(row.spec1 || "");

    const tdSpec2 = document.createElement("td");
    tdSpec2.innerHTML = formatCellText(row.spec2 || "");

    const tdPrio = document.createElement("td");
    tdPrio.innerHTML = formatCellText(row.priority || "");

    const tdNotes = document.createElement("td");
    tdNotes.innerHTML = formatCellText(row.notes || "");

    tr.appendChild(tdLoot);
    tr.appendChild(tdType);
    tr.appendChild(tdBis);
    tr.appendChild(tdSpec1);
    tr.appendChild(tdSpec2);
    tr.appendChild(tdPrio);
    tr.appendChild(tdNotes);

    tbody.appendChild(tr);
  });

  applyBisRarity();
  applyClassColors();

  // üî• TR√àS IMPORTANT : dire √† Wowhead de rescanner les liens
  if (typeof $WowheadPower !== "undefined" &&
      typeof $WowheadPower.refreshLinks === "function") {
    $WowheadPower.refreshLinks();
  }
}



// Applique les couleurs de raret√© BIS (colonne 3)
function applyBisRarity() {
  const rows = document.querySelectorAll("#lootBody tr");
  rows.forEach(row => {
    const cells = row.querySelectorAll("td");
    if (cells.length < 3) return;
    const bisCell = cells[2];
    const text = bisCell.textContent.trim();

    let rarityClass = null;
    if (text === "BP1") {
      rarityClass = "rarity-common";
    } else if (text === "BP2") {
      rarityClass = "rarity-uncommon";
    } else if (text === "BP3") {
      rarityClass = "rarity-rare";
    } else if (text === "BP4") {
      rarityClass = "rarity-epic";
    } else if (text === "BP5") {
      rarityClass = "rarity-legendary";
    }

    if (rarityClass) {
      bisCell.classList.add("rarity-bp", rarityClass);
    }
  });
}

// Applique les couleurs de classes dans la colonne Priorit√©
function applyClassColors() {
  const rows = document.querySelectorAll("#lootBody tr");
  rows.forEach(row => {
    const cells = row.querySelectorAll("td");
    if (cells.length < 6) return;

    const prioCell = cells[5];
    let html = prioCell.innerHTML;

    CLASS_KEYS.forEach(key => {
      const cssClass = wowClassMap[key];
      const re = new RegExp("\\b" + key.replace(/[-\/\\^$*+?.()|[\]{}]/g, "\\$&") + "\\b", "g");
      html = html.replace(re, '<span class="' + cssClass + '">' + key + '</span>');
    });

    prioCell.innerHTML = html;
  });
}

// === Initialisation =============================================
document.addEventListener("DOMContentLoaded", () => {
  const raidSelect = document.getElementById("raidSelect");

  // Remplir le select des raids
  RAIDS.forEach(raid => {
    const opt = document.createElement("option");
    opt.value = raid.id;
    opt.textContent = raid.name;
    raidSelect.appendChild(opt);
  });

  // Raid par d√©faut : Karazhan si pr√©sent
  const defaultRaid = RAIDS[0]?.id || "";
  if (defaultRaid) {
    raidSelect.value = defaultRaid;
    loadRaid(defaultRaid);
  }

  raidSelect.addEventListener("change", () => {
    const id = raidSelect.value;
    if (id) loadRaid(id);
  });

  document.getElementById("bossSelect").addEventListener("change", () => {
    renderTable();
  });
});
</script>

</body>
</html>
