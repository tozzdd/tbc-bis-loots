<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>TBC BIS Loots - Multi-raids</title>
<style>
body {
  font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  background: #111827;
  color: #e5e7eb;
  padding: 2rem;
}
h1 {
  color: #fbbf24;
  margin-bottom: 0.5rem;
}
p.subtitle {
  color: #9ca3af;
  margin-bottom: 1.5rem;
}

/* --- Credits + BuyMeACoffee block --- */
.credits-container {
  position: absolute;
  top: 20px;
  right: 20px;
  text-align: right;
}
.credits-container img {
  width: 180px;
  border-radius: 6px;
  margin-bottom: 0.6rem;
}
.credits-list p {
  margin: 0;
  color: #d1d5db;
  font-size: 0.85rem;
}
.credits-list span {
  color: #fbbf24;
  font-weight: 600;
}

/* Barre de sélection */
.controls {
  display: flex;
  flex-wrap: wrap;
  gap: 0.75rem;
  margin-bottom: 1rem;
  align-items: center;
}
.controls label {
  font-size: 0.9rem;
  color: #d1d5db;
}
.controls select {
  background: #111827;
  color: #e5e7eb;
  border: 1px solid #374151;
  border-radius: 0.375rem;
  padding: 0.3rem 0.6rem;
  font-size: 0.9rem;
}

/* Table pleine largeur */
table {
  border-collapse: collapse;
  width: 100vw;
  max-width: 100vw;
  margin-left: calc(-50vw + 50%);
  font-size: 0.9rem;
}
th, td {
  border: 1px solid #374151;
  padding: 0.4rem 1rem 0.4rem 1.2rem;
  font-size: 1.05rem;
  vertical-align: middle;
}
th {
  background: #1f2937;
  font-weight: 600;
  text-align: left;
}
tr:nth-child(even) td {
  background: #030712;
}
a:not([href*="wowhead.com"]) {
  color: #60a5fa;
}
a {
  text-decoration: none;
}
a:hover {
  text-decoration: underline;
}

/* Titre de boss */
.boss-title td {
  background: #1f2937;
  color: #fbbf24;
  font-weight: 700;
  font-size: 2rem !important;
  text-align: left;
  border-top: 2px solid #4b5563;
  border-bottom: 2px solid #4b5563;
  padding: 1rem 1rem 1rem 1.4rem;
}

.loot-col { width: 22%; }
.type-col { width: 12%; }
.notes-col { width: 28%; }

/* Icône item Wowhead plus grande dans la 1ère colonne */
#lootBody td:first-child a.icontinyl {
  background-size: 20px 20px !important;
  padding-left: 30px !important;
  min-height: 20px;
  display: inline-flex;
  align-items: center;
}

/* Couleurs des classes WoW */
.wow-druid   { color: #FF7D0A; }
.wow-hunter  { color: #ABD473; }
.wow-mage    { color: #40C7EB; }
.wow-paladin { color: #F58CBA; }
.wow-priest  { color: #FFFFFF; }
.wow-rogue   { color: #FFF569; }
.wow-shaman  { color: #0070DE; }
.wow-warlock { color: #8787ED; }
.wow-warrior { color: #C79C6E; }

/* Rareté BIS */
.rarity-bp {
  font-weight: 700;
}
.rarity-common    { color: #ffffff; }
.rarity-uncommon  { color: #1eff00; }
.rarity-rare      { color: #0070dd; }
.rarity-epic      { color: #a335ee; }
.rarity-legendary { color: #ff8000; }
</style>

<script>
  // Wowhead tooltips
  var whTooltips = {
    colorLinks: true,
    iconizeLinks: true,
    renameLinks: false,
    locale: "fr_FR"
  };
</script>
<script src="https://wow.zamimg.com/widgets/power.js"></script>
</head>
<body>

<div class="credits-container">
  <div class="bmc-button">
    <a href="https://www.buymeacoffee.com/Tozz" target="_blank">
      <img src="https://img.buymeacoffee.com/button-api/?text=Buy me a coffee&emoji=&slug=Tozz&button_colour=FFDD00&font_colour=000000&font_family=Cookie&outline_colour=000000&coffee_colour=ffffff" />
    </a>
  </div>
  <div class="credits-list">
    <p><span>Datamining :</span> Kerishai</p>
    <p><span>Ideas & Seeking :</span> Captp</p>
    <p><span>Conception :</span> Tozz</p>
  </div>
</div>

<h1>TBC – BIS Loots by MEUPORG</h1>
<p class="subtitle">
Choisissez un raid, un boss, une classe et/ou un rôle pour afficher les loots. Survolez le nom pour voir le tooltip Wowhead.
</p>

<div class="controls">
  <label for="raidSelect">Raid :</label>
  <select id="raidSelect"></select>

  <label for="bossSelect">Boss :</label>
  <select id="bossSelect">
    <option value="">Tous les boss</option>
  </select>

  <!-- Nouveau : filtre Classe -->
  <label for="classFilter">Classe :</label>
  <select id="classFilter">
    <option value="">Toutes</option>
    <option value="Paladin">Paladin</option>
    <option value="Guerrier">Guerrier</option>
    <option value="Druide">Druide</option>
    <option value="Chaman">Chaman</option>
    <option value="Prêtre">Prêtre</option>
    <option value="Voleur">Voleur</option>
    <option value="Chasseur">Chasseur</option>
    <option value="Démoniste">Démoniste</option>
    <option value="Mage">Mage</option>
  </select>

  <!-- Nouveau : filtre Rôle -->
  <label for="roleFilter">Rôle :</label>
  <select id="roleFilter">
    <option value="">Tous</option>
    <option value="Tank">Tank</option>
    <option value="Heal">Heal</option>
    <option value="DPS">DPS</option>
  </select>
</div>

<table>
  <thead>
    <tr>
      <th class="loot-col">Loot</th>
      <th class="type-col">Type</th>
      <th>BIS</th>
      <th>Spé 1</th>
      <th>Spé 2</th>
      <th>Priorité</th>
      <th class="notes-col">Notes</th>
    </tr>
  </thead>
  <tbody id="lootBody">
    <!-- Rempli dynamiquement -->
  </tbody>
</table>

<script>
// === Config des raids (chemins CSV) ===============================
const RAIDS = [
  { id: "karazhan",  name: "[P1] Karazhan", csv: "CSV/karazhan.csv" },
  { id: "mags_gruul_worldboss", name: "[P1] Magtheridon / Gruul / World Boss", csv: "CSV/mags_gruul_worldboss.csv" },
  { id: "ssc",       name: "[P2] Caverne du sanctuaire du Serpent", csv: "CSV/ssc.csv" },
  { id: "tk",        name: "[P2] Donjon de la Tempête (The Eye)", csv: "CSV/tk.csv" },
  { id: "hyjal",     name: "[P3] Sommet d’Hyjal", csv: "CSV/hyjal.csv" },
  { id: "bt",        name: "[P3] Temple noir (BT)", csv: "CSV/bt.csv" },
  { id: "za",        name: "[P4] Zul’Aman", csv: "CSV/za.csv" },
  { id: "swp",       name: "[P5] Plateau du Puits de soleil (SWP)", csv: "CSV/swp.csv" },
  { id: "t4",        name: "[P1] Set T4", csv: "CSV/t4.csv" },
  { id: "t5",        name: "[P2] Set T5", csv: "CSV/t5.csv" },
  { id: "t6",        name: "[P3] Set T6", csv: "CSV/t6.csv" }
];

// === Mapping classes -> couleurs ===============================
const wowClassMap = {
  "Holy Paladin": "wow-paladin",
  "Resto Shaman": "wow-shaman",
  "Resto Druid": "wow-druid",
  "Prot Paladin": "wow-paladin",
  "Prot Warrior": "wow-warrior",
  "War Fury": "wow-warrior",
  "War Armes": "wow-warrior",
  "War Tank": "wow-warrior",

  "Druide": "wow-druid",
  "Druid": "wow-druid",
  "RDru": "wow-druid",
  "Feral": "wow-druid",
  "Bear": "wow-druid",
  "Cat": "wow-druid",
  "Boom": "wow-druid",
  "Boomy": "wow-druid",

  "Hunt": "wow-hunter",
  "Chasseur": "wow-hunter",
  "Hunter": "wow-hunter",
  "Chassou": "wow-hunter",
  "SurvHunt": "wow-hunter",

  "Mage": "wow-mage",

  "Paladin": "wow-paladin",
  "HPal": "wow-paladin",
  "PPal": "wow-paladin",
  "Ret": "wow-paladin",
  "PRet": "wow-paladin",
  "RPal": "wow-paladin",

  "Priest": "wow-priest",
  "HPri": "wow-priest",
  "Shadow": "wow-priest",
  "SP": "wow-priest",

  "Rog": "wow-rogue",
  "Rogue": "wow-rogue",

  "Shaman": "wow-shaman",
  "Sha": "wow-shaman",
  "RSha": "wow-shaman",
  "RSh": "wow-shaman",
  "Rcham": "wow-shaman",
  "Ele": "wow-shaman",
  "Elem": "wow-shaman",
  "Enh": "wow-shaman",
  "Amélio": "wow-shaman",
  "chaman": "wow-shaman",
  "Chaman": "wow-shaman",

  "Lock": "wow-warlock",
  "Warlock": "wow-warlock",
  "démo": "wow-warlock",

  "Warrior": "wow-warrior",
  "PWar": "wow-warrior",
  "Fury": "wow-warrior",
  "Arms": "wow-warrior"
};

// Clés triées par longueur pour éviter que "Paladin" matche avant "Holy Paladin"
const CLASS_KEYS = Object.keys(wowClassMap).sort((a, b) => b.length - a.length);

// === Détection Classe / Rôle pour le filtrage ===================

// Classe -> tokens à chercher dans (spec1 + spec2 + priority)
const CLASS_FILTERS = {
  "Paladin":  ["paladin", "hpal", "ppal", "pret", "rpal"],
  "Guerrier": ["warrior", "pwar", "fury", "arms", "war tank"],
  "Druide":   ["druide", "druid", "rdru", "feral", "bear", "cat", "boomy", "boom"],
  "Chaman":   ["chaman", "sha", "rcham", "rsha", "elem", "elemental", "amélio", "enh"],
  "Prêtre":   ["priest", "hpri", "shadow", "sp"],
  "Voleur":   ["rogue", "rog"],
  "Chasseur": ["chasseur", "hunt", "bmhunt", "survhunt", "chassou"],
  "Démoniste":["démo", "warlock", "lock"],
  "Mage":     ["mage"]
};

// Rôle -> tokens à chercher
const ROLE_FILTERS = {
  "Tank": [
    "tank", "prot warrior", "prot paladin", "pwar", "ppal",
    "bear", "war tank", "feral tank"
  ],
  "Heal": [
    "heal", "holy paladin", "hpal", "hpri",
    "resto druid", "rdru", "resto shaman", "rcham", "rsha", "rsh"
  ],
  "DPS": [
    "dps", "boomy", "boom", "elem", "elemental", "sp",
    "rogue", "rog", "chasseur", "hunt", "bmhunt", "survhunt",
    "fury", "arms", "pret", "pret", "feral", "cat", "démo", "warlock",
    "lock", "mage"
  ]
};

// Retourne les sets {classes, roles} détectés pour une ligne
function getRowMeta(row) {
  const txt = (row.priority || "").toLowerCase();

  const classes = new Set();
  const roles   = new Set();

  for (const [cls, tokens] of Object.entries(CLASS_FILTERS)) {
    if (tokens.some(t => txt.includes(t))) {
      classes.add(cls);
    }
  }

  for (const [role, tokens] of Object.entries(ROLE_FILTERS)) {
    if (tokens.some(t => txt.includes(t))) {
      roles.add(role);
    }
  }

  return { classes, roles };
}

// === CSV parser maison (gère les quotes, virgules, retours) =====
function parseCSV(text) {
  const rows = [];
  let field = "";
  let row = [];
  let inQuotes = false;

  for (let i = 0; i < text.length; i++) {
    const c = text[i];

    if (c === '"') {
      if (inQuotes && text[i + 1] === '"') {
        field += '"';
        i++;
      } else {
        inQuotes = !inQuotes;
      }
    } else if (c === ',' && !inQuotes) {
      row.push(field);
      field = "";
    } else if ((c === '\n' || c === '\r') && !inQuotes) {
      if (field.length > 0 || row.length > 0) {
        row.push(field);
        rows.push(row);
      }
      field = "";
      row = [];
      if (c === '\r' && text[i + 1] === '\n') {
        i++;
      }
    } else {
      field += c;
    }
  }

  if (field.length > 0 || row.length > 0) {
    row.push(field);
    rows.push(row);
  }

  return rows;
}

// Transforme en objets avec les noms de colonnes
function csvToObjects(text) {
  const rows = parseCSV(text);
  if (!rows.length) return [];
  const headers = rows[0].map(h => h.trim());
  const data = [];

  for (let i = 1; i < rows.length; i++) {
    const row = rows[i];
    if (row.every(v => !v || v.trim() === "")) continue;
    const obj = {};
    headers.forEach((h, idx) => {
      obj[h] = row[idx] !== undefined ? row[idx] : "";
    });
    data.push(obj);
  }
  return data;
}

// Helpers pour la mise en forme texte
function escapeHTML(str) {
  return str
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;");
}
function formatCellText(value) {
  if (!value) return "";
  return escapeHTML(value).replace(/\n/g, "<br>");
}

// Données courantes
let currentRaidId = null;
let currentData = [];

// Chargement d'un raid
async function loadRaid(raidId) {
  const raid = RAIDS.find(r => r.id === raidId);
  if (!raid) return;

  currentRaidId = raidId;
  const res = await fetch(raid.csv);
  const text = await res.text();
  currentData = csvToObjects(text);

  populateBossSelect();
  renderTable();
}

// Remplir le select des boss
function populateBossSelect() {
  const bossSelect = document.getElementById("bossSelect");
  bossSelect.innerHTML = "";

  const optAll = document.createElement("option");
  optAll.value = "";
  optAll.textContent = "Tous les boss";
  bossSelect.appendChild(optAll);

  const bosses = [];
  currentData.forEach(row => {
    const b = (row.boss || "").trim();
    if (b && !bosses.includes(b)) bosses.push(b);
  });

  bosses.forEach(bossName => {
    const opt = document.createElement("option");
    opt.value = bossName;
    opt.textContent = bossName;
    bossSelect.appendChild(opt);
  });
}

  // Combos classe + rôle pour un match strict sur la colonne priorité
const CLASS_ROLE_COMBOS = {
  "Paladin:Tank": ["ppal", "prot paladin", "paladin prot"],
  "Paladin:Heal": ["hpal", "holy paladin"],
  "Paladin:DPS":  ["pret"],

  "Guerrier:Tank": ["pwar", "prot warrior", "war tank"],
  "Guerrier:DPS":  ["fury", "arms"],

  "Druide:Tank": ["bear", "feral tank"],
  "Druide:Heal": ["rdru", "resto druid"],
  "Druide:DPS":  ["boomy", "feral", "cat"],

  "Chaman:Heal": ["rcham", "resto shaman"],
  "Chaman:DPS":  ["amélio", "elem"],

  "Prêtre:Heal": ["hpri"],
  "Prêtre:DPS":  ["sp"],

  "Chasseur:DPS": ["chasseur", "bmhunt", "survhunt"],

  "Voleur:DPS":   ["rogue", "rog"],
  "Démoniste:DPS":["démo"],
  "Mage:DPS":     ["mage"]
};

// Vérifie si, pour une ligne donnée, un couple (classe, rôle) est bien présent
function classRoleMatchesRow(row, classFilter, roleFilter) {
  if (!classFilter || !roleFilter) return true; // si un seul des deux est filtré, on ne durcit pas

  const key = classFilter + ":" + roleFilter;
  const combos = CLASS_ROLE_COMBOS[key];
  if (!combos || !combos.length) {
    // pas de combos définis pour ce couple -> on ne bloque pas
    return true;
  }

  const txt = (row.priority || "").toLowerCase();

  return combos.some(token => txt.includes(token.toLowerCase()));
}

  
// Rendu du tableau (avec filtres boss + classe + rôle)
function renderTable() {
  const tbody = document.getElementById("lootBody");
  tbody.innerHTML = "";

  const bossFilter  = document.getElementById("bossSelect").value;
  const classFilter = document.getElementById("classFilter").value;
  const roleFilter  = document.getElementById("roleFilter").value;

  const filtered = currentData.filter(row => {
    // Filtre boss
    if (bossFilter && (row.boss || "").trim() !== bossFilter) {
      return false;
    }

    // Métadonnées de la ligne
const { classes, roles } = getRowMeta(row);

// filtre classe seule
if (classFilter && !classes.has(classFilter)) {
  return false;
}

// filtre rôle seul
if (roleFilter && !roles.has(roleFilter)) {
  return false;
}

// combo classe + rôle : on durcit avec les patterns
if (classFilter && roleFilter) {
  if (!classRoleMatchesRow(row, classFilter, roleFilter)) {
    return false;
  }
}

    return true;
  });

  let lastBoss = null;

  filtered.forEach(row => {
    const bossName = (row.boss || "").trim();

    if (bossName && bossName !== lastBoss) {
      const trBoss = document.createElement("tr");
      trBoss.className = "boss-title";
      const td = document.createElement("td");
      td.colSpan = 7;
      td.textContent = bossName;
      trBoss.appendChild(td);
      tbody.appendChild(trBoss);
      lastBoss = bossName;
    }

    const tr = document.createElement("tr");

    const tdLoot = document.createElement("td");
    const lootName = row.loot_name || "";
    const lootUrl = row.loot_url || "";
    if (lootUrl) {
      tdLoot.innerHTML =
        '<a href="' + escapeHTML(lootUrl) + '">' + escapeHTML(lootName) + '</a>';
    } else {
      tdLoot.textContent = lootName;
    }

    const tdType = document.createElement("td");
    tdType.innerHTML = formatCellText(row.type || "");

    const tdBis = document.createElement("td");
    const bisText = (row.bis || "").trim();
    tdBis.textContent = bisText;

    const tdSpec1 = document.createElement("td");
    tdSpec1.innerHTML = formatCellText(row.spec1 || "");

    const tdSpec2 = document.createElement("td");
    tdSpec2.innerHTML = formatCellText(row.spec2 || "");

    const tdPrio = document.createElement("td");
    tdPrio.innerHTML = formatCellText(row.priority || "");

    const tdNotes = document.createElement("td");
    tdNotes.innerHTML = formatCellText(row.notes || "");

    tr.appendChild(tdLoot);
    tr.appendChild(tdType);
    tr.appendChild(tdBis);
    tr.appendChild(tdSpec1);
    tr.appendChild(tdSpec2);
    tr.appendChild(tdPrio);
    tr.appendChild(tdNotes);

    tbody.appendChild(tr);
  });

  applyBisRarity();
  applyClassColors();

  // Refresh Wowhead (icônes + couleur de lien)
  if (typeof $WowheadPower !== "undefined" &&
      typeof $WowheadPower.refreshLinks === "function") {
    $WowheadPower.refreshLinks();
  }
}

// Applique les couleurs de rareté BIS
function applyBisRarity() {
  const rows = document.querySelectorAll("#lootBody tr");
  rows.forEach(row => {
    const cells = row.querySelectorAll("td");
    if (cells.length < 3) return;
    const bisCell = cells[2];
    const text = bisCell.textContent.trim();

    let rarityClass = null;
    if (text === "BP1") {
      rarityClass = "rarity-common";
    } else if (text === "BP2") {
      rarityClass = "rarity-uncommon";
    } else if (text === "BP3") {
      rarityClass = "rarity-rare";
    } else if (text === "BP4") {
      rarityClass = "rarity-epic";
    } else if (text === "BP5") {
      rarityClass = "rarity-legendary";
    }

    if (rarityClass) {
      bisCell.classList.add("rarity-bp", rarityClass);
    }
  });
}

// Applique les couleurs de classes dans la colonne Priorité
function applyClassColors() {
  const rows = document.querySelectorAll("#lootBody tr");
  rows.forEach(row => {
    const cells = row.querySelectorAll("td");
    if (cells.length < 6) return;

    const prioCell = cells[5];
    let html = prioCell.innerHTML;

    CLASS_KEYS.forEach(key => {
      const cssClass = wowClassMap[key];
      const re = new RegExp("\\b" + key.replace(/[-\/\\^$*+?.()|[\]{}]/g, "\\$&") + "\\b", "g");
      html = html.replace(re, '<span class="' + cssClass + '">' + key + '</span>');
    });

    prioCell.innerHTML = html;
  });
}

// Initialisation
document.addEventListener("DOMContentLoaded", () => {
  const raidSelect  = document.getElementById("raidSelect");
  const bossSelect  = document.getElementById("bossSelect");
  const classSelect = document.getElementById("classFilter");
  const roleSelect  = document.getElementById("roleFilter");

  // Remplir le select des raids
  RAIDS.forEach(raid => {
    const opt = document.createElement("option");
    opt.value = raid.id;
    opt.textContent = raid.name;
    raidSelect.appendChild(opt);
  });

  const defaultRaid = RAIDS[0]?.id || "";
  if (defaultRaid) {
    raidSelect.value = defaultRaid;
    loadRaid(defaultRaid);
  }

  raidSelect.addEventListener("change", () => {
    const id = raidSelect.value;
    if (id) loadRaid(id);
  });

  bossSelect.addEventListener("change", () => {
    renderTable();
  });

  classSelect.addEventListener("change", () => {
    renderTable();
  });

  roleSelect.addEventListener("change", () => {
    renderTable();
  });
});
</script>

</body>
</html>
