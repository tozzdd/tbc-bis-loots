<!doctype html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <title>TBC BIS Loots - Multi-raids</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="assets/style.css" />

    <script>
      var whTooltips = {
        colorLinks: true,
        iconizeLinks: true,
        renameLinks: false,
        locale: "fr_FR"
      };
    </script>
    <script src="https://wow.zamimg.com/widgets/power.js"></script>
  </head>

  <body>
    <div id="app">
      <div class="wide-row">
        <!-- ================= TABLE ================= -->
        <table>
          <thead>
            <tr>
              <th class="loot-col">Loot</th>
              <th class="type-col">Type</th>
              <th>BIS</th>
              <th>Spé 1</th>
              <th>Spé 2</th>
              <th>Priorité</th>
              <th class="notes-col">Notes</th>
            </tr>
          </thead>
          <tbody id="lootBody"></tbody>
        </table>
      </div>
    </div>

    <script>
      /* =====================================================
         NORMALISATION TEXTE (FIX MAJEUR)
      ===================================================== */
      function normalizeTxt(str) {
        return (str || "")
          .toLowerCase()
          .normalize("NFD")
          .replace(/[\u0300-\u036f]/g, "");
      }

      /* =====================================================
         CLASS / ROLE FILTERS (TOKENS NORMALISÉS)
      ===================================================== */
      const CLASS_FILTERS = {
        Paladin: ["paladin", "hpal", "ppal", "pret", "rpal"],
        Guerrier: ["warrior", "pwar", "fury", "arms", "war tank"],
        Druide: ["druide", "druid", "rdru", "feral", "bear", "cat", "boomy", "boom"],
        Chaman: ["chaman", "sha", "rcham", "rsha", "elem", "elemental", "amelio", "enh"],
        Prêtre: ["priest", "hpri", "shadow", "sp"],
        Voleur: ["rogue", "rog"],
        Chasseur: ["chasseur", "hunt", "bmhunt", "survhunt", "chassou"],
        Démoniste: ["demo", "warlock", "lock"],
        Mage: ["mage"]
      };

      const ROLE_FILTERS = {
        Tank: ["tank", "prot warrior", "prot paladin", "pwar", "ppal", "bear"],
        Heal: ["heal", "holy paladin", "hpal", "hpri", "resto druid", "rdru", "resto shaman", "rcham", "rsha"],
        DPS: ["dps", "boomy", "elem", "sp", "rogue", "hunt", "fury", "arms", "pret", "feral", "demo", "mage"]
      };

      const CLASS_ROLE_COMBOS = {
        "Paladin:Tank": ["ppal", "prot paladin"],
        "Paladin:Heal": ["hpal", "holy paladin"],
        "Paladin:DPS": ["pret"],

        "Guerrier:Tank": ["pwar", "prot warrior"],
        "Guerrier:DPS": ["fury", "arms"],

        "Druide:Tank": ["bear", "feral tank"],
        "Druide:Heal": ["rdru"],
        "Druide:DPS": ["boomy", "cat"],

        "Chaman:Heal": ["rcham", "rsha"],
        "Chaman:DPS": ["amelio", "elem"],

        "Prêtre:Heal": ["hpri"],
        "Prêtre:DPS": ["sp"],

        "Chasseur:DPS": ["hunt"],
        "Voleur:DPS": ["rogue"],
        "Démoniste:DPS": ["demo"],
        "Mage:DPS": ["mage"]
      };

      function getRowMeta(row) {
        const txt = normalizeTxt(row.priority);
        const classes = new Set();
        const roles = new Set();

        for (const [cls, tokens] of Object.entries(CLASS_FILTERS)) {
          if (tokens.some((t) => txt.includes(t))) classes.add(cls);
        }
        for (const [role, tokens] of Object.entries(ROLE_FILTERS)) {
          if (tokens.some((t) => txt.includes(t))) roles.add(role);
        }
        return { classes, roles };
      }

      function classRoleMatchesRow(row, classFilter, roleFilter) {
        const key = `${classFilter}:${roleFilter}`;
        const combos = CLASS_ROLE_COMBOS[key];
        if (!combos) return true;

        const txt = normalizeTxt(row.priority);
        return combos.some((t) => txt.includes(t));
      }

      /* =====================================================
         RENDER TABLE (FIX FILTRAGE)
      ===================================================== */
      function renderTable() {
        const tbody = document.getElementById("lootBody");
        tbody.innerHTML = "";

        const bossFilter = bossSelect.value;
        const bisFilter = bisSelect.value;
        const classFilter = classSelect.value;
        const roleFilter = roleSelect.value;

        const filtered = currentData.filter((row) => {
          if (bossFilter && row.boss !== bossFilter) return false;
          if (bisFilter && row.bis !== bisFilter) return false;

          const { classes, roles } = getRowMeta(row);

          if (classFilter && classes.size && !classes.has(classFilter)) return false;
          if (roleFilter && roles.size && !roles.has(roleFilter)) return false;

          if (classFilter && roleFilter && classes.size && roles.size) {
            if (!classRoleMatchesRow(row, classFilter, roleFilter)) return false;
          }

          return true;
        });

        let lastBoss = null;

        filtered.forEach((row) => {
          if (row.boss && row.boss !== lastBoss) {
            const trBoss = document.createElement("tr");
            trBoss.className = "boss-title";
            trBoss.innerHTML = `<td colspan="7">${row.boss}</td>`;
            tbody.appendChild(trBoss);
            lastBoss = row.boss;
          }

          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td><a href="${row.loot_url}">${row.loot_name}</a></td>
            <td>${row.type || ""}</td>
            <td>${row.bis || ""}</td>
            <td>${row.spec1 || ""}</td>
            <td>${row.spec2 || ""}</td>
            <td>${row.priority || ""}</td>
            <td>${row.notes || ""}</td>
          `;
          tbody.appendChild(tr);
        });

        if (typeof $WowheadPower !== "undefined") {
          $WowheadPower.refreshLinks();
        }
      }
    </script>
  </body>
</html>
